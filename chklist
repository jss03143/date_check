import tkinter as tk
from tkinter import messagebox, ttk
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import ctypes

# ================= ì„¤ì • ê°’ =================
JSON_KEYFILE = 'credentials.json'
SHEET_NAME = 'maple chklist'
FONT_NAME = "ë©”ì´í”ŒìŠ¤í† ë¦¬ Light"
# ===========================================

class MapleFinalApp:
    def __init__(self, root):
        self.root = root
        self.root.title("ğŸ“Š ì¼ì • ì²´í¬ë¦¬ìŠ¤íŠ¸")
        
        # 4K í™˜ê²½ì„ ê³ ë ¤í•œ ê¸°ë³¸ ì°½ í¬ê¸° ì„¤ì •
        self.root.geometry("1850x1000")

        # ì°½ ì¢…ë£Œ(X) ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í”„ë¡œí† ì½œ ì—°ê²°
        self.root.protocol("WM_DELETE_WINDOW", self.on_closing)

        self.check_vars = [] 
        self.data = {}
        self.cat_order = [] 
        self.is_delete_mode = False 
        self.is_edit_mode = False 

        # í°íŠ¸ ì„¤ì •
        self.large_font = (FONT_NAME, 15)
        self.bold_font = (FONT_NAME, 15, "bold")
        self.cat_font = (FONT_NAME, 12, "bold")
        self.item_font = (FONT_NAME, 10)
        self.small_font = (FONT_NAME, 9)

        # ì…ë ¥ ê¸€ì ìˆ˜ ì œí•œ ê²€ì¦
        self.vcmd_cat = (self.root.register(lambda P: len(P) <= 10), '%P')
        self.vcmd_task = (self.root.register(lambda P: len(P) <= 20), '%P')

        self.setup_google_sheets()
        self.refresh_data_from_sheet()
        self.create_widgets()

        # ì°½ í¬ê¸° ë³€ê²½ ì‹œ UI ê°±ì‹  (ì§€ì—° ì‹¤í–‰)
        self._after_id = None
        self.root.bind("<Configure>", self.on_window_resize)

    def on_closing(self):
        # í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ í˜¸ì¶œë˜ì–´ ë°ì´í„°ë¥¼ ìë™ ì €ì¥í•¨
        try:
            # ì‚­ì œ/í¸ì§‘ ëª¨ë“œê°€ ì•„ë‹ ë•Œ ì•ˆì „í•˜ê²Œ ìë™ ì €ì¥ ì‹œë„
            if not self.is_delete_mode and not self.is_edit_mode:
                self.sync_to_sheet(silent=True)
        except:
            pass
        self.root.destroy()

    def setup_google_sheets(self):
        try:
            scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
            creds = ServiceAccountCredentials.from_json_keyfile_name(JSON_KEYFILE, scope)
            self.client = gspread.authorize(creds)
            self.spreadsheet = self.client.open(SHEET_NAME)
            
            try:
                self.sheet = self.spreadsheet.worksheet("ì‹œíŠ¸1")
            except gspread.exceptions.WorksheetNotFound:
                # 'Main'ì´ë¼ëŠ” ì´ë¦„ì˜ íƒ­ì´ ì—†ë‹¤ë©´ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
                messagebox.showerror("ì˜¤ë¥˜", "'Main' ì›Œí¬ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nêµ¬ê¸€ ì‹œíŠ¸ì˜ íƒ­ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")
                self.root.destroy()
                
        except Exception as e:
            messagebox.showerror("ì—°ê²° ì˜¤ë¥˜", f"ì‹œíŠ¸ ì—°ê²° ì‹¤íŒ¨: {e}")
            self.root.destroy()

    def refresh_data_from_sheet(self):
        try:
            all_records = self.sheet.get_all_records()
            self.data = {}
            temp_cat_order = {}
            for row in all_records:
                main_cat = str(row.get('MainCategory', 'ê¸°íƒ€'))
                cycle = row.get('Cycle', 'ì£¼ê°„')
                if cycle in ['weekly', 'ì£¼ê°„']: cycle = 'ì£¼ê°„'
                else: cycle = 'ì›”ê°„'
                
                order = row.get('Order', 999)
                if main_cat not in self.data:
                    self.data[main_cat] = {"ì£¼ê°„": [], "ì›”ê°„": []}
                    temp_cat_order[main_cat] = order
                self.data[main_cat][cycle].append({
                    "task": str(row.get('Task')), 
                    "done": str(row.get('Done')).upper() == 'TRUE'
                })
            self.cat_order = sorted(temp_cat_order.keys(), key=lambda x: temp_cat_order[x])
        except:
            self.data, self.cat_order = {}, []

    def create_widgets(self):
        # ìƒë‹¨ ì…ë ¥ë¶€
        input_frame = tk.LabelFrame(self.root, text="ğŸ†• ìƒˆ í•  ì¼ ì¶”ê°€", padx=10, pady=10, font=self.cat_font)
        input_frame.pack(fill="x", padx=20, pady=10)
        
        top_inner = tk.Frame(input_frame)
        top_inner.pack(pady=5)

        tk.Label(top_inner, text="ğŸ“‚ ëŒ€ì£¼ì œ:", font=self.large_font).grid(row=0, column=0, padx=5)
        self.main_cat_entry = tk.Entry(top_inner, font=self.large_font, width=15, validate='key', validatecommand=self.vcmd_cat)
        self.main_cat_entry.grid(row=0, column=1, padx=10)

        tk.Label(top_inner, text="ğŸ“ í•  ì¼:", font=self.large_font).grid(row=0, column=2, padx=5)
        self.task_entry = tk.Entry(top_inner, font=self.large_font, width=25, validate='key', validatecommand=self.vcmd_task)
        self.task_entry.grid(row=0, column=3, padx=10)

        self.cycle_combo = ttk.Combobox(top_inner, values=["ì£¼ê°„", "ì›”ê°„"], state="readonly", font=self.large_font, width=8)
        self.cycle_combo.current(0)
        self.cycle_combo.grid(row=0, column=4, padx=5)

        tk.Button(input_frame, text="ì¶”ê°€í•˜ê¸°", command=self.add_task, font=self.bold_font).pack(fill="x", pady=5)

        # ì œì–´ ë²„íŠ¼
        btn_frame = tk.Frame(self.root)
        btn_frame.pack(fill="x", padx=20, pady=5)
        
        tk.Button(btn_frame, text="ğŸ’¾ ìˆ˜ë™ ì €ì¥", bg="#4CAF50", fg="white", font=self.bold_font, command=self.sync_to_sheet).pack(side="left", expand=True, fill="x", padx=2)
        self.edit_btn = tk.Button(btn_frame, text="âš™ï¸ í¸ì§‘ ëª¨ë“œ OFF", bg="#607D8B", fg="white", font=self.bold_font, command=self.toggle_edit_mode)
        self.edit_btn.pack(side="left", expand=True, fill="x", padx=2)
        self.mode_btn = tk.Button(btn_frame, text="ğŸ—‘ï¸ ì‚­ì œ ëª¨ë“œ OFF", bg="#9E9E9E", fg="white", font=self.bold_font, command=self.toggle_delete_mode)
        self.mode_btn.pack(side="left", expand=True, fill="x", padx=2)

        # ìŠ¤í¬ë¡¤ ë¦¬ìŠ¤íŠ¸ ì˜ì—­
        self.outer_frame = tk.Frame(self.root)
        self.outer_frame.pack(fill="both", expand=True, padx=20, pady=10)
        
        self.canvas = tk.Canvas(self.outer_frame, highlightthickness=0)
        self.scroll_frame = tk.Frame(self.canvas)
        self.scrollbar = tk.Scrollbar(self.outer_frame, orient="vertical", command=self.canvas.yview)
        
        self.canvas.configure(yscrollcommand=self.scrollbar.set)
        self.scrollbar.pack(side="right", fill="y")
        self.canvas.pack(side="left", fill="both", expand=True)
        self.canvas_window = self.canvas.create_window((0,0), window=self.scroll_frame, anchor="nw")

    def on_window_resize(self, event):
        if event.widget == self.root:
            if self._after_id: self.root.after_cancel(self._after_id)
            self._after_id = self.root.after(100, self.refresh_ui)

    def refresh_ui(self):
        for widget in self.scroll_frame.winfo_children(): widget.destroy()
        self.check_vars = []
        bg_color = "white"
        if self.is_delete_mode: bg_color = "#fff5f5"
        elif self.is_edit_mode: bg_color = "#f0f7ff"
        
        self.scroll_frame.config(bg=bg_color)
        self.canvas.config(bg=bg_color)

        # ê°€ë¡œ 8ì—´ ê³ ì • ì„¤ì •
        cols = 8
        for i in range(cols):
            self.scroll_frame.grid_columnconfigure(i, weight=1, uniform="fixed_eight")

        for index, main_cat in enumerate(self.cat_order):
            if main_cat not in self.data: continue
            r, c = divmod(index, cols)
            
            card = tk.LabelFrame(self.scroll_frame, relief="groove", bd=1, bg=bg_color)
            card.grid(row=r, column=c, padx=4, pady=8, sticky="nsew")
            
            title_bar = tk.Frame(card, bg=bg_color)
            title_bar.pack(fill="x")
            cat_label = tk.Label(title_bar, text=f"ğŸ“‚ {main_cat}", font=self.cat_font, bg=bg_color, cursor="hand2")
            cat_label.pack(side="left", padx=5, pady=5)
            cat_label.bind("<Button-1>", lambda e, c=main_cat: self.set_cat_from_click(c))

            if self.is_edit_mode:
                tk.Button(title_bar, text="â–¶", command=lambda i=index: self.move_category(i, 1), font=("Arial", 6), width=2).pack(side="right")
                tk.Button(title_bar, text="â—€", command=lambda i=index: self.move_category(i, -1), font=("Arial", 6), width=2).pack(side="right")
            
            for cycle in ["ì£¼ê°„", "ì›”ê°„"]:
                tasks = self.data[main_cat][cycle]
                if tasks:
                    tk.Label(card, text=f"â€¢ {cycle}", fg="#666666", bg=bg_color, font=self.small_font).pack(anchor="w", padx=5)
                    for i, item in enumerate(tasks):
                        item_frame = tk.Frame(card, bg=bg_color)
                        item_frame.pack(fill="x", padx=5)
                        
                        var = tk.BooleanVar(value=False if self.is_delete_mode else item["done"])
                        self.check_vars.append((main_cat, cycle, i, var))
                        
                        cb = tk.Checkbutton(item_frame, text=item["task"], variable=var, bg=bg_color,
                                            font=self.item_font, wraplength=170, justify="left")
                        cb.pack(side="left", anchor="w")

                        if self.is_edit_mode:
                            btn_f = tk.Frame(item_frame, bg=bg_color)
                            btn_f.pack(side="right")
                            tk.Button(btn_f, text="â–²", command=lambda m=main_cat, cy=cycle, idx=i: self.move_task(m, cy, idx, -1), font=("Arial", 6), width=1).pack()
                            tk.Button(btn_f, text="â–¼", command=lambda m=main_cat, cy=cycle, idx=i: self.move_task(m, cy, idx, 1), font=("Arial", 6), width=1).pack()

        # í•˜ë‹¨ ì—¬ë°±ìš© ìŠ¤í˜ì´ì„œ
        footer_spacer = tk.Frame(self.scroll_frame, height=100, bg=bg_color)
        footer_spacer.grid(row=(len(self.cat_order)//cols) + 1, column=0, columnspan=cols)

        self.scroll_frame.update_idletasks()
        self.canvas.configure(scrollregion=self.canvas.bbox("all"))

    def set_cat_from_click(self, cat_name):
        self.main_cat_entry.delete(0, tk.END)
        self.main_cat_entry.insert(0, cat_name)
        self.task_entry.focus_set()

    def sync_to_sheet(self, silent=False):
        # í˜„ì¬ UIì˜ ìƒíƒœë¥¼ ìº¡ì²˜í•˜ì—¬ êµ¬ê¸€ ì‹œíŠ¸ì— ì—…ë°ì´íŠ¸
        if not self.is_delete_mode:
            for m_cat, cycle, idx, var in self.check_vars:
                if m_cat in self.data and idx < len(self.data[m_cat][cycle]):
                    self.data[m_cat][cycle][idx]["done"] = var.get()

        rows = [["MainCategory", "Cycle", "Task", "Done", "Order"]]
        for order_idx, m_cat in enumerate(self.cat_order):
            if m_cat in self.data:
                for cycle in ["ì£¼ê°„", "ì›”ê°„"]:
                    for item in self.data[m_cat][cycle]:
                        rows.append([m_cat, cycle, item["task"], item["done"], order_idx])
        try:
            self.sheet.batch_clear(["A:E"])
            self.sheet.update('A1', rows)
            if not silent: messagebox.showinfo("ì™„ë£Œ", "êµ¬ê¸€ ì‹œíŠ¸ ì €ì¥ ì„±ê³µ!")
        except:
            if not silent: messagebox.showerror("ì˜¤ë¥˜", "ì‹œíŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ")

    def toggle_edit_mode(self):
        self.is_edit_mode = not self.is_edit_mode
        self.is_delete_mode = False
        self.edit_btn.config(text="âœ¨ í¸ì§‘ ëª¨ë“œ ON" if self.is_edit_mode else "âš™ï¸ í¸ì§‘ ëª¨ë“œ OFF", bg="#2196F3" if self.is_edit_mode else "#607D8B")
        self.mode_btn.config(text="ğŸ—‘ï¸ ì‚­ì œ ëª¨ë“œ OFF", bg="#9E9E9E")
        self.refresh_ui()

    def toggle_delete_mode(self):
        self.is_delete_mode = not self.is_delete_mode
        self.is_edit_mode = False
        if self.is_delete_mode:
            self.mode_btn.config(text="ğŸ”¥ ì„ íƒ í•­ëª© ì‚­ì œ ì‹¤í–‰", bg="#f44336")
        else:
            self.execute_delete_checked()
            self.mode_btn.config(text="ğŸ—‘ï¸ ì‚­ì œ ëª¨ë“œ OFF", bg="#9E9E9E")
        self.refresh_ui()

    def execute_delete_checked(self):
        to_delete = [item for item in self.check_vars if item[3].get()]
        if not to_delete: return
        if messagebox.askyesno("ì‚­ì œ í™•ì¸", f"{len(to_delete)}ê°œ í•­ëª©ì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            for m_cat, cycle, idx, var in sorted(to_delete, key=lambda x: x[2], reverse=True):
                if m_cat in self.data: del self.data[m_cat][cycle][idx]
            for cat in list(self.data.keys()):
                if not any(self.data[cat].values()):
                    del self.data[cat]
                    if cat in self.cat_order: self.cat_order.remove(cat)
            self.sync_to_sheet(silent=True)
            self.refresh_ui()

    def add_task(self):
        m_cat, task, cycle = self.main_cat_entry.get().strip(), self.task_entry.get().strip(), self.cycle_combo.get()
        if m_cat and task:
            if m_cat not in self.data:
                self.data[m_cat] = {"ì£¼ê°„": [], "ì›”ê°„": []}
                self.cat_order.append(m_cat)
            self.data[m_cat][cycle].append({"task": task, "done": False})
            self.task_entry.delete(0, tk.END)
            self.refresh_ui()

    def move_category(self, index, direction):
        new_index = index + direction
        if 0 <= new_index < len(self.cat_order):
            self.cat_order[index], self.cat_order[new_index] = self.cat_order[new_index], self.cat_order[index]
            self.refresh_ui()

    def move_task(self, cat, cycle, index, direction):
        tasks = self.data[cat][cycle]
        new_index = index + direction
        if 0 <= new_index < len(tasks):
            tasks[index], tasks[new_index] = tasks[new_index], tasks[index]
            self.refresh_ui()

if __name__ == "__main__":
    # ê³ í•´ìƒë„(DPI) ìµœì í™” ì„¤ì •
    try:
        ctypes.windll.shcore.SetProcessDpiAwareness(1)
    except:
        try: ctypes.windll.user32.SetProcessDPIAware()
        except: pass

    root = tk.Tk()
    app = MapleFinalApp(root)
    root.mainloop()
